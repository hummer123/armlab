"""
UR5e机械臂DH参数建模详解
====================================

DH参数 (Denavit-Hartenberg Parameters) 是机器人运动学中用于描述串联机械臂
相邻连杆之间关系的标准方法。

## 一、DH参数基础理论

### 1.1 什么是DH参数？

DH参数使用4个参数来描述相邻两个连杆之间的空间关系：

┌─────────────┬──────────────────────────────────────────┐
│  参数符号   │              物理意义                    │
├─────────────┼──────────────────────────────────────────┤
│  θ (theta)  │ 关节角：绕Z轴的旋转角度（对于旋转关节） │
│  d          │ 连杆偏距：沿Z轴的平移距离                │
│  a (α)      │ 连杆长度：沿X轴的距离                    │
│  α (alpha)  │ 连杆扭转角：绕X轴的旋转角度              │
└─────────────┴──────────────────────────────────────────┘

### 1.2 DH坐标系建立规则

1. **Z轴**：沿关节轴线方向
2. **X轴**：从Z(i-1)到Z(i)的公垂线方向
3. **Y轴**：根据右手定则确定

### 1.3 DH变换矩阵

从连杆i-1到连杆i的变换矩阵：

    T(i-1,i) = Rot(Z, θ) · Trans(Z, d) · Trans(X, a) · Rot(X, α)

展开形式：

    | cos(θ)  -sin(θ)cos(α)   sin(θ)sin(α)   a·cos(θ) |
    | sin(θ)   cos(θ)cos(α)  -cos(θ)sin(α)   a·sin(θ) |
    |   0        sin(α)          cos(α)          d     |
    |   0          0               0            1     |


## 二、UR5e机械臂DH参数表

根据URDF文件分析，UR5e的DH参数如下：

┌────────┬────────┬────────┬────────┬────────┬──────────────────┐
│ 关节i  │   θi   │   di   │   ai   │   αi   │      说明        │
├────────┼────────┼────────┼────────┼────────┼──────────────────┤
│   1    │   θ1*  │ 0.163  │   0    │  π/2   │ 基座旋转         │
│   2    │   θ2*  │   0    │ 0.425  │   0    │ 肩部升降         │
│   3    │   θ3*  │   0    │ 0.392  │   0    │ 肘关节           │
│   4    │   θ4*  │ 0.127  │   0    │  π/2   │ 腕部1            │
│   5    │   θ5*  │ 0.1    │   0    │ -π/2   │ 腕部2            │
│   6    │   θ6*  │ 0.1    │   0    │   0    │ 腕部3/末端       │
└────────┴────────┴────────┴────────┴────────┴──────────────────┘

* θi 为关节变量（可变）


## 三、UR5e机械臂结构图解

### 3.1 侧视图（XZ平面）

          Z
          ↑
          │
    ┌─────┴─────┐
    │   Base    │ ← d1 = 0.163m (基座高度)
    └───────────┘
          │θ1 (绕Z轴旋转)
          │
      ┌───┴───┐
      │Shoulder│ ← 肩部关节
      └───┬───┘
          │θ2 (绕Y轴旋转)
          │
          │ a2 = 0.425m (大臂)
          │
      ┌───┴───┐
      │ Elbow │ ← 肘关节
      └───┬───┘
          │θ3 (绕Y轴旋转)
          │
          │ a3 = 0.392m (小臂)
          │
      ┌───┴───┐
      │Wrist 1│ ← d4 = 0.127m
      └───┬───┘
          │θ4
      ┌───┴───┐
      │Wrist 2│ ← d5 = 0.1m
      └───┬───┘
          │θ5
      ┌───┴───┐
      │Wrist 3│ ← d6 = 0.1m
      └───┬───┘
          │θ6
       ╔═══╧═══╗
       ║  EE   ║ ← 末端执行器
       ╚═══════╝


### 3.2 坐标系示意图

从URDF提取的关键几何信息：

关节1 (shoulder_pan):
    - 父连杆: base_link
    - xyz: [0, 0, 0.163]  → d1 = 0.163m
    - 旋转轴: Z轴
    - 范围: [-2π, 2π]

关节2 (shoulder_lift):
    - 父连杆: shoulder_link  
    - xyz: [0, 0.138, 0]  → 偏移量
    - 旋转轴: Y轴
    - 范围: [-2π, 2π]

关节3 (elbow):
    - 父连杆: upper_arm_link
    - xyz: [0, -0.131, 0.425]  → a2 = 0.425m
    - 旋转轴: Y轴
    - 范围: [-π, π]

关节4 (wrist_1):
    - 父连杆: forearm_link
    - xyz: [0, 0, 0.392]  → a3 = 0.392m
    - 旋转轴: Y轴

关节5 (wrist_2):
    - 父连杆: wrist_1_link
    - xyz: [0, 0.127, 0]  → d4 = 0.127m
    - 旋转轴: Z轴

关节6 (wrist_3):
    - 父连杆: wrist_2_link
    - xyz: [0, 0, 0.1]  → d5 = 0.1m
    - 旋转轴: Y轴

末端执行器 (ee):
    - 父连杆: wrist_3_link
    - xyz: [0, 0.1, 0]  → d6 = 0.1m


## 四、从URDF到DH参数的转换方法

### 4.1 识别步骤

1. **找出所有关节的origin xyz**
   - 这些值给出了相对父连杆的位置偏移

2. **识别旋转轴方向**
   - axis xyz给出了关节旋转轴

3. **计算DH参数**
   - d: 沿前一个Z轴的偏移
   - a: 沿当前X轴的偏移（连杆长度）
   - α: 连杆扭转角（前后Z轴夹角）
   - θ: 关节角（变量）

### 4.2 URDF vs DH 对照

URDF中的 <origin xyz="x y z" rpy="r p y" />：
- xyz: 相对父坐标系的平移
- rpy: 相对父坐标系的旋转（Roll-Pitch-Yaw）

需要转换为DH的 [θ, d, a, α]：
- 分析xyz的每个分量对应DH的哪个参数
- 分析rpy旋转对应的扭转角α


## 五、正向运动学示例

计算末端执行器位置（给定关节角度）：

```python
def forward_kinematics_dh(theta1, theta2, theta3, theta4, theta5, theta6):
    # DH参数
    DH = [
        [theta1,  0.163,    0,    np.pi/2],   # 关节1
        [theta2,      0, 0.425,         0],   # 关节2
        [theta3,      0, 0.392,         0],   # 关节3
        [theta4,  0.127,    0,    np.pi/2],   # 关节4
        [theta5,    0.1,    0,   -np.pi/2],   # 关节5
        [theta6,    0.1,    0,         0],   # 关节6
    ]
    
    # 计算变换矩阵
    T = np.eye(4)
    for theta, d, a, alpha in DH:
        Ti = dh_transform(theta, d, a, alpha)
        T = T @ Ti
    
    # 末端位置
    position = T[0:3, 3]
    return position
```


## 六、工作空间边界计算

### 6.1 理论最大延伸

水平方向：
    R_max = a2 + a3 = 0.425 + 0.392 = 0.817 m

垂直方向：
    Z_max = d1 + a2 + a3 = 0.163 + 0.425 + 0.392 = 0.98 m
    Z_min = d1 - (a2 + a3) = 0.163 - 0.817 = -0.654 m

### 6.2 考虑关节限位后的实际工作空间

由于elbow_joint的限位是[-π, π]，实际工作空间会受限制。

建议使用蒙特卡洛方法或数值分析来精确计算。


## 七、参考资料

1. Craig, J. J. (2005). Introduction to Robotics: Mechanics and Control
2. Spong, M. W., et al. (2006). Robot Modeling and Control
3. UR5e官方技术文档
4. ROS URDF规范文档

"""

# 保存为Markdown格式以便查看
def save_as_markdown():
    content = __doc__
    with open('/home/unitree/ws/sim/armlab/arm/DH_Parameters_Guide.md', 'w', encoding='utf-8') as f:
        f.write(content)
    print("DH参数指南已保存到: arm/DH_Parameters_Guide.md")

if __name__ == "__main__":
    save_as_markdown()
